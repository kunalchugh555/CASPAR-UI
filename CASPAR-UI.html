<!DOCTYPE html>
<html>
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"> <!--scales to client device size-->
  <title> CASPAR </title>

  <script src="https://www.puck-js.com/puck.js"></script>
  <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.css" />

<style>
  /* Purely stylistic so it looks pretty */
  body{font-family: verdana, Arial;}
  .header {padding:1px; background-color: LightGray; text-align: center}
  .tab button { font-size: 120%; background-color:#f0f0f0; margin-top: 8px; margin-right:8px; padding: 5px; cursor: pointer;
   border-width: 2px; border-radius: 3px}
  .tab button:hover {background-color: #b4b4b4;}
  .tab button.active {background-color: #787878; color: #f0f0f0}
  .tabcontent {}
  .inrbtn{font-size: 100%; background-color:#b4b4b4; margin-top: 8px; margin-right:8px; padding: 5px; cursor: pointer;
   border-width: 2px; border-radius: 3px}
  .inrinp{type = "text"; width: 10%; height:22px; font-size:12pt; border-width: 1px;}
</style>
</head>

<body>

  <div class="header">
    <h1> CASPAR </h1>
  </div>

  <div class="tab">
    <button class="tablinks" id = "Tab1" onclick="Show(event, 'Tab1C')">Tab 1</button>
    <button class="tablinks" id = "Tab2" onclick="Show(event, 'Tab2C')">Tab 2</button>
    <button class="tablinks" id = "Tab3" onclick="Show(event, 'Tab3C')">Tab 3</button>
  </div>

  <div id="Tab1C" class="tabcontent">
    <div id ="divider1" style="width:1000px; height:6px;"></div>
    <button class="inrbtn" id="start_PCR" > Start/Stop PCR </button>
    <button class="inrbtn" id="myrecord_start" > Start New Recording </button>
    <button class="inrbtn" id="my_Savedata" > Email Data </button>
    <button class="inrbtn" id="closeserver" > SHUTDOWN SERVER (DO NOT PRESS UNLESS YOU MEAN IT) </button>
    <input class = "inrinp" id="filename">
    <button class="inrbtn" id="submitfilename" > Set Save Data Filename </button>

    <div id ="divider2" style="width:800px; height:14px;"> </div>
    <div id="div_g" style="width:1000px; height:500px; margin: auto;"></div>
    <div id="divider3" style="width:1000px; height:40px;"></div>
    <div id="div_pcr" style="width:1000px; height:500px; margin: auto;"></div>
  </div>

  <div id="Tab2C" class="tabcontent">
    <p> Content 2 </p>
  </div>

  <div id="Tab3C" class="tabcontent">
    <p> Content 3 </p>
  </div>

  <script type="text/javascript">
    const ws = new WebSocket('ws://10.8.129.234:7071/ws');

    //Declare data vectors for graphs and push initial values into them.
    var data = [];
    var data2 =[];
    var cycleno = 0;             // Cycle the next set of PCR data will be from.
    var t = new Date();         // Current time.
    data.push([t, 0, 0]);
    data2.push([cycleno, 0, 0]);

    // Harness a variable to each button to handle events later.
    var b_startPCR = document.getElementById("start_PCR");
    var emailmyfiles = document.getElementById("my_Savedata");
    var rec_startstop = document.getElementById("myrecord_start");
    var servershutdown = document.getElementById("closeserver");

    var taxis_increment = 10 * 1000;          // axis increment in milliseconds

    // Initialize variables for data handling.
    var x = 0;
    var y = 0;
    var fam;
    var cy5;
    var cycleno = 0;
    var date_win_min = t.getTime();
    var date_win_max = date_win_min + 2*taxis_increment;

    // Handles the events coming from the websocket. Format switches off the id blank on the json variable being sent.
    ws.onmessage = function(event){
      var msg = JSON.parse(event.data);
        switch(msg.id){
          case "connect":
            console.log(msg.status);
          break;
          case "cycledata":
            x = new Date();  // Get current time
            y = msg.fluor; // Get fluoresence.
            temp = msg.temp; // Get temperature.

            //Move the window if needed:
            if ( x.getTime() >= date_win_max) {
              date_win_min += taxis_increment;
              date_win_max += taxis_increment;
              g.updateOptions( { dateWindow : [date_win_min, date_win_max] } ) };

            //Update the data, then graph it.
            if(y > -100)
              {data.push([x,y,temp]);
               g.updateOptions( { 'file': data } );};
          break;
          case "PCRdata":
            cycleno = cycleno + 1; //Increase PCR cycle on receipt of PCR data.
            fam = msg.fam; //Retrieve FAM fluoresence.
            cy5 = msg.cyfive; //Retrieve Cy5 fluoresence.
            data2.push([cycleno, fam, cy5]); //Push the new data onto the graph source.
            pcr.updateOptions( {'file': data2 } ); //Update it.
          break;
          case "filestatus":
            console.log(msg.status); //Log the confirmation of filename change.
          break;
          default:
            console.log(msg); //If the message doesn't match any of our cases, log the message in the console.
          }};

    // Declare our graph for cycling data.
    var g = new Dygraph(document.getElementById("div_g"), data,
      {labels: ['Time','F','Temp'],
       series: {
          'F': {
            axis:'y1'}, // Put our fluoresence on the left axis.
          'Temp': {
            axis:'y2'}, // Put our temperature on the right axis.
          },
          axes: { // Declare two sets of axes.
                'y1': {},
                'y2': {},
          },
          title: 'Cycling Information',
          xlabel: 'Time',
          ylabel: 'Fluoresence (mV)',
          y2label: 'Temperature (Celsius)',
          drawPoints: true,
          showRoller: true,
          digitsAfterDecimal: 3,
          dateWindow: [date_win_min, date_win_max],
          showRangeSelector: true,
          axisLabelFontSize: 12,
    });

    // Declare the graph for PCR data.
    var pcr = new Dygraph(document.getElementById("div_pcr"), data2,
      {labels: ['Cycle','FAM','Cy5'],
       series: {
         'FAM': {
          axis:'y1'},
         'HEX': {
          axis:'y1'},
          },
          axes: {
                'y1': {},
          },
          title: 'PCR Output',
          xlabel: 'Cycle',
          ylabel: 'Fluoresence (mV)',
          drawPoints: true,
          showRoller: true,
          digitsAfterDecimal: 3,
          dateWindow: [0,40], //This locks the x axis to 0-40.
          showRangeSelector: true,
          axisLabelFontSize: 14,
    });

    //Changes files based off the textbox on the page and sends the name to the server. The server will reject the request if it's running.
    function changeFile()
      {var nameforchange = document.getElementById("filename").value;
          var msg = {
            id: "filename",
            newname: nameforchange};
          ws.send(JSON.stringify(msg));}

    //Turns the server off. Don't call this. Really don't.
    function stopserver() {
          var msg = {
            id: "shutdown"};
          ws.send(JSON.stringify(msg));}

    // Start or stop the PCR depending on its current state.
    function startPCR() {
          var msg = {
            id: "start/stop"};
          ws.send(JSON.stringify(msg));}

    // Rewriting this to email the files to a chosen address.
    function sendfiles() {
          var msg = {
            id: "sendemail"};
          ws.send(JSON.stringify(msg));}

    //Sets up all the events for the events listener.
    $(document).ready(function () {
        b_startPCR.addEventListener("click", function () { startPCR() } );
        emailmyfiles.addEventListener("click", function () { sendfiles() } );
        // rec_startstop.addEventListener("click", function () { startstop_record() } );
        servershutdown.addEventListener("click", function () { stopserver()});
        submitfilename.addEventListener("click", function() {changeFile()});
        });

    //Shows tabs when tabs are clicked
    function Show(evt, contentid) {
      var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
          }
        tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
          }
      document.getElementById(contentid).style.display = "block";
      evt.currentTarget.className += " active"; }

    document.getElementById("Tab1").click(); //By Default, the first tab is shown.
  </script>
</body>
</html>
