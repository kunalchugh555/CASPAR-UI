<!DOCTYPE html>
<html>
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"> <!--scales to client device size-->
  <title> CASPAR </title>

  <script src="https://www.puck-js.com/puck.js"></script>
  <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.css" />

<style>
  /* Purely stylistic so it looks pretty */
  body{font-family: verdana, Arial;}
  .tab button {font-size:120%; background-color:#f0f0f0; margin-top:8px; margin-right:8px; padding:5px; cursor:pointer;
   border-width:2px; border-radius: 3px}
    .tab button:hover {background-color: #b4b4b4;}
    .tab button.active {background-color: #787878; color: #f0f0f0}
  .tabcontent {}
  .inrbtn{display: block; font-size: 125%; background-color:#b4b4b4; padding: 12px; cursor: pointer;
   border-width: 2px; border-radius: 3px; margin: 53px auto;}
    .inrbtn2{display: block; font-size: 125%; background-color:#b4b4b4; padding: 12px; cursor: pointer;
    border-width: 2px; border-radius: 3px; margin:auto; margin-top: 48px; margin-bottom: 48px;}
    .inrbtn3{display: block; font-size: 150%; background-color:#b4b4b4; padding: 12px; cursor: pointer;
    border-width: 2px; border-radius: 3px; margin:auto; margin-top: 48px; margin-bottom: 48px;}
    .btmbtn{display: inline; font-size: 150%; background-color:#b4b4b4; padding: 5px; cursor: pointer;
    border-width: 2px; border-radius: 3px;}
  .inrtxt{font-size: 110%; text-align: center; margin:35px}
    .inrtxt2{font-size: 110%; text-align: center; margin:30px}
    .inrtxt3{font-size: 110%; margin:15px}
    .inrtxt4{font-size: 115%; margin-top:40px; margin-bottom: 20px;}
    .inrtxt5{font-size: 105%; margin-top:40px; margin-bottom: 20px;}
  .inrinp{width: 85%; height:25px; font-size:12pt; border-width: 1px; padding:3px 8px;}
    .inrinp1{width: 17%; height:25px; font-size:12pt; border-width: 1px; padding:3px 8px;}
    .btminp{width: 30%; height:50%; font-size:12pt; border-width: 1px; padding:3px 8px; resize: none; display:inline;}

  /* grids/layputs for each tab */
  .container1 {display: grid;
  grid-template-columns: 0.75fr 0.75fr 1fr 1fr 1fr 1fr 1fr 1fr 0.75fr 0.75fr;
  grid-template-rows: 1.1fr 1.1fr 1.1fr 1.1fr 1.1fr 1.1fr 0.4fr;
  grid-column-gap: 8px;
  grid-row-gap: 8px;}
  .div1-1 { grid-area: 1 / 1 / 6 / 3; border-style:solid; border-width: 2px} /*left content */
  .div2-1 { grid-area: 1 / 3 / 6 / 9; border-style:solid; border-width: 2px} /*middle content */
  .div3-1 { grid-area: 1 / 9 / 6 / 11; border-style:solid; border-width: 2px} /*right content */
  .div4-1 { grid-area: 6 / 1 / 8 / 11; border-style:solid; border-width: 2px;} /*bottom content */

  .container2 {display: grid;
  grid-template-columns: 0.75fr 0.75fr 1fr 1fr 1fr 1fr 1fr 1fr 0.75fr 0.75fr;
  grid-template-rows: 1.1fr 1.1fr 1.1fr 1.1fr 1.1fr 1.1fr 0.4fr;
  grid-column-gap: 8px;
  grid-row-gap: 8px;} /*same grid as container1*/
  .div1-2 { grid-area: 1 / 1 / 6 / 3; border-style:solid; border-width: 2px} /*left content */
  .div2-2 { grid-area: 1 / 3 / 6 / 9; border-style:solid; border-width: 2px} /*middle content */
  .div3-2 { grid-area: 1 / 9 / 6 / 11; border-style:solid; border-width: 2px} /*right content */
  .div4-2 { grid-area: 6 / 1 / 8 / 11; border-style:solid; border-width: 2px;} /*bottom content */

  .container3 {display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    grid-template-rows: 1fr 1fr 1fr 1fr;
    grid-column-gap: 8px;
    grid-row-gap: 8px;}
  .div1-3 { grid-area: 1 / 1 / 5 / 3; border-style:solid; border-width: 2px} /*left content */
  .div2-3 { grid-area: 1 / 3 / 5 / 5; border-style:solid; border-width: 2px} /*right content */

  /*DropDown Menu on the First Tab*/
  .custom-select {position: relative;}
    .custom-select select {display: none;} /*hide original select element:*/
  .select-selected {background-color:#b4b4b4; border: 6px;}
    .select-selected:after {position: absolute; content: ""; top: 14px; right: 10px;width: 0px; height: 0px; border: 6px solid transparent;
     border-color: #3c3c3c transparent transparent transparent;} /*point the arrow upwards when the select box is open:*/
    .select-selected.select-arrow-active:after { border-color: transparent transparent #3c3c3c transparent; top: 7px;}
  .select-items div,.select-selected {padding: 6px 8px; border: 1px solid transparent;
   border-color: #000000 #000000 #000000 #000000; cursor: pointer; user-select: none;} /*style the options*/
    .select-items {position: absolute; background-color: #b4b4b4; border-radius: 3px; top: 100%; left: 0; right: 0; z-index: 99;}
  .select-hide {display: none;} /*hide items when the select box is closed:*/
  .select-items div:hover, .same-as-selected {background-color: rgba(0, 0, 0, 0.1);}
  .disable{pointer-events:none;}
</style>
</head>

<body>

  <div class="tab">
    <button class="tablinks" id = "tab1" onclick="show(event, 'tab1c')">Main</button>
    <button class="tablinks" id = "tab2" onclick="show(event, 'tab2c')">Run Summary</button>
    <button class="tablinks" id = "tab3" onclick="show(event, 'tab3c')">Configuration</button> <!--Name Change-->
    <button id="help" style="float:right" onclick="help()"> Help </button>
    <button id="close" style = "float:right;" onclick = "closeConfirmation()"> Close Website </button>
    <button id="closeServer" style="float:right" onclick = "shutdownConfirmation()"> Shutdown Server (DO NOT PRESS) </button>
    <button id="serverStatus" style="float:right; pointer-events: none;" > Server Status: <span style = "font-weight:bold;"> Not Connected </span> </button>
  </div>

  <div id="divider" style="width:1200px; height:8px; margin: auto;"></div>

  <div id="tab1c" class="tabcontent">
    <div class="container1">
      <div class="div1-1"  style = "text-align:center;">
        <p class="inrtxt2">Project Name:</p>
        <input class = "inrinp" type="text" id="projName">
        <p class="inrtxt2">Operator:</p>
        <input class = "inrinp" type="text" id="opName">
        <p class="inrtxt2">Experiment Name:</p>
        <input class = "inrinp" type="text" id="expName">
        <p class="inrtxt2">Configurations:</p>
        <div id = "dropdown" class="custom-select" style="width:93%; margin:0 auto; margin-bottom: 30px;">
          <select style="text-align:left;">
            <option value="0" id="none">&emsp;</option> <!-- blank line -->
            <option value="1" id="V">V</option> <!--Change-->
            <option value="2" id="W">W</option> <!--Change-->
            <option value="3" id="X">X</option> <!--Change-->
            <option value="4" id="Y">Y</option> <!--Change-->
            <option value="5" id="Z">Z</option> <!--Change-->
          </select>
        </div>
      </div>

      <div class="div2-1" id="divPCR" style="width:100%; height:100%; display:block;"></div> <!--graph goes here-->

      <div class="div3-1">
        <button class="inrbtn" id="startStopPCR" onclick = "startStopConfirmation()"; style = "font-size: 160%; padding: 20px; margin: 80px auto; background-color: LimeGreen">Start PCR</button> <!--Changes-->
        <p class="inrtxt">Current Cycle:</p>
        <p class="inrtxt" id="currentCycle" style="font-weight:bold; font-size:120%; margin-bottom:48px;"> 0 </p> <!--Changes-->
        <p class="inrtxt">Total Cycles:</p>
        <p class="inrtxt" id="totalCycles" style="font-weight:bold; font-size:120%"> - </p> <!--Changing will be implemented-->
      </div>

      <div class="div4-1">
        <p class="inrtxt3" style="margin-top: 42px; display:inline; float:left; font-size:110%; margin-left:20px;"> <br> Comments:</p>
        <textarea class = "btminp" type="text" id="comments" style="display:inline-flex; margin-top: 40px; float:left;"></textarea>
        <p class="inrtxt3" id="systemStatus" style="display:inline; float:left; font-size:110%; margin-left:55px;"> <br> System Status:
          <br> <br> <span style= "font-weight: bold; font-size:110%;"> &ensp;Not Running </span></p> <!--Changes-->
        <p class="inrtxt3" id="startTime" style="display:inline; float:left; font-size:110%; margin-left:55px;"> <br> Start Time:
          <br> <br> <span style= "font-weight: bold; font-size:110%"> &ensp; Not Started </span></p> <!--Changes-->
        <p class="inrtxt3" id="estFinTime" style="display:inline; float:left; font-size:110%; margin-left:55px;"> <br> Est. Finish Time:
          <br> <br> <span style= "font-weight: bold; font-size:110%"> &emsp; &emsp; &ensp; - </span></p> <!--Changing will be implemented-->
        <p class="inrtxt3" id="finTime" style="display:inline; float:left; font-size:110%; margin-left:55px;"> <br> Finish Time:
          <br> <br> <span style= "font-weight: bold; font-size:110%"> &emsp; &emsp; - </span></p> <!--Changing will be implemented-->
      </div>

    </div>
  </div>

  <div id="tab2c" class="tabcontent">
    <div class="container2">

      <div class="div1-2">
        <p class="inrtxt4" style="font-weight:bold; text-align: center; margin-top: 20px;">Experiment Info:</p>
        <p class="inrtxt3" id="errorMessages" style="font-size:105%;"> Status: Not Completed <br> <br> Errors: Check Error Status <br> <br> Configuration: X
          <br> <br> Project Name: Pigs <br> <br> Start Time: 9:00:00 AM <br> <br> Est. Finish Time: 10:00:00 AM <br> <br> Finish Time: 11:00:00 AM </p>  <!--Changing will be implemented-->
      </div>

      <div class="div2-2" id="graphDiv" style="width:100%; height:100%; display:block;"> </div> <!--graph goes here-->

      <div class="div3-2">
        <p class="inrtxt4" style="font-weight:bold; text-align: center; margin-top: 20px;">Error Status:</p>
        <p class = 'inrtxt3' id="errorInfo"> No errors found</p> <!--Changing will be implemented-->
      </div>

      <div class="div4-2">
        <p class="inrtxt3" style="margin-top: 42px; display:inline; float:left; font-size:110%; margin-left:20px;"> Save Data Filename:</p>
        <input class = "inrinp1" type="text" id="filename" style="display:inline-flex; margin-top: 40px; float:left;" value=""></input>
        <button class="inrbtn2" id="downloadData" style = "display:inline; margin-top: 28px; margin-left:55px; float:left; margin-bottom: 10px;"> Download Data </button>
        <p class="inrtxt3" style="margin-top: 42px; display:inline; float:left; font-size:110%; margin-left:45px;"> Enter Email:</p>
        <input class = "inrinp1" type="text" id="email" style="display:inline-flex; margin-top: 40px; float:left;" value=""></input>
        <button class="inrbtn2" id="emailData" onclick = "sendFiles()" style = "display:inline; margin-top: 28px; margin-left:55px; float:left; margin-bottom: 10px;">
          Email Data </button>
      </div>
    </div>
  </div>

  <div id="tab3c" class="tabcontent">
    <div class="container3">

      <div class="div1-3">
        <h2 style = "text-align: center;"> Configuration Information </h2>
        <p class = 'inrtxt3'> Configuration: V <br> <br> Total Cycles: 50 <br> <br> Default Operator Name: Nick
          <br> <br> Default Email: nick@gmail.com <br> <br> Default Project Name: Pigs </p> <!--Changing will be implemented-->
        <p class="inrtxt4" style="font-weight:bold; text-align: left; margin-left: 10px;">Device Info:</p>
        <p class="inrtxt5" id="deviceInfo">&emsp;Model 1.0</p> <!--Changing will be implemented-->
        <p class="inrtxt4" style="font-weight:bold; text-align: left; margin-left: 10px;">Version Info:</p>
        <p class="inrtxt5" id="versionInfo">&emsp;Version 1.0</p> <!--Changing will be implemented-->
      </div>

      <div class="div2-3">
        <h2 style = "text-align: center;"> Create Configuration </h2>
        <p class = 'inrtxt3'> Configuration Name: U <br> <br> Total Cycles: 150 <br> <br> Default Operator Name: Bill
          <br> <br> Default Email: bill@gmail.com <br> <br> Default Project Name: morePigs </p> <!--Changing will be implemented-->
        <button class="inrbtn3" id="saveConfig" style= "display: inline; float:left; margin-left: 70px; margin-bottom: 20px;"> Save <br> This <br> Configuration </button>
        <button class="inrbtn3" id="devMode" style= "display: inline; float:right; margin-right: 70px; margin-bottom: 20px;"> Launch <br> Developer <br> Mode </button>
      </div>

    </div>
  </div>

  <script type="text/javascript">
    const ws = new WebSocket('ws://10.68.206.224:7071/ws');

    //Declare data vectors for graphs and push initial values into them.
    var data = [];
    var data2 = [];
    var cycleno = 0;             // Cycle the next set of PCR data will be from.
    var t = new Date();         // Current time.
    data.push([t, 0, 0]);
    data2.push([cycleno, 0, 0]);

    var taxis_increment = 10 * 1000; // axis increment in milliseconds

    // Initialize variables for data handling.
    var x = 0;
    var y = 0;
    var fam;
    var cy5;
    var cycleno = 0;
    var date_win_min = t.getTime();
    var date_win_max = date_win_min + 2*taxis_increment;

    var isRunning = false; //Keeps track of whether the system is actually running. NOT the same as clientStarted, which is when the client presses start

    // Handles the events coming from the websocket. Format switches off the id blank on the json variable being sent.
    ws.onmessage = function(event){
      var msg = JSON.parse(event.data);
        switch(msg.id){

          case "connect":
            isRunning = msg.running;
            console.log(msg.status);
              document.getElementById('serverStatus').innerHTML =  "Server Status: <span style = 'color:LimeGreen;font-weight:bold;''> Connected </span>"; //Changes Server Status
            //alert(isRunning);
            onConnect(msg.running, msg.starttime, msg.projectname, msg.operatorname, msg.experimentname, msg.configname, msg.comments, msg.filename);

            if (isRunning == "true")
            {
              document.getElementById("systemStatus").innerHTML = "<br> System Status: <br> <br> <span style=font-size:110%;color:LimeGreen;font-weight:bold;> &ensp;"
              + "In Progress" + "</span>";
            }
            else if(isRunning == "false")
            {
              document.getElementById("systemStatus").innerHTML = "<br> System Status: <br> <br> <span style=font-size:110%;font-weight:bold;> &ensp;"
              + "Not Running" + "</span>";
            }

          break;

          case "cycledata":
            isRunning = msg.running;
            x = new Date();  // Get current time
            y = msg.fluor; // Get fluoresence.
            temp = msg.temp; // Get temperature.
          //Move the window if needed:
            if (x.getTime() >= date_win_max) {
              date_win_min += taxis_increment;
              date_win_max += taxis_increment;
              g.updateOptions( { dateWindow : [date_win_min, date_win_max] } )};
          //Update the data, then graph it.
            if(y > -100)
              {data.push([x,y,temp]);
               g.updateOptions( { 'file': data } );};

               if (isRunning == "true")
               {
                 document.getElementById("systemStatus").innerHTML = "<br> System Status: <br> <br> <span style=font-size:110%;color:LimeGreen;font-weight:bold;> &ensp;"
                 + "In Progress" + "</span>";
               }
               else if(isRunning == "false")
               {
                 document.getElementById("systemStatus").innerHTML = "<br> System Status: <br> <br> <span style=font-size:110%;font-weight:bold;> &ensp;"
                 + "Not Running" + "</span>";
               }
          break;

          case "PCRdata": //In the future, msg.cycleno will give us the real cycleno
            isRunning = msg.running;
            cycleno = cycleno + 1; //Increase PCR cycle on receipt of PCR data.
              document.getElementById("currentCycle").innerHTML =  "<span style='font-weight:bold; font-size:110%'>" + cycleno + "</span>"; //Changes Cycle Number
            fam = msg.fam; //Retrieve FAM fluoresence.
            cy5 = msg.cy5; //Retrieve Cy5 fluoresence.
            data2.push([cycleno, fam, cy5]); //Push the new data onto the graph source.
            pcr.updateOptions( {'file': data2 } ); //Update it.

            if (isRunning == "true")
            {
              document.getElementById("systemStatus").innerHTML = "<br> System Status: <br> <br> <span style=font-size:110%;color:LimeGreen;font-weight:bold;> &ensp;"
              + "In Progress" + "</span>";
            }
            else if(isRunning == "false")
            {
              document.getElementById("systemStatus").innerHTML = "<br> System Status: <br> <br> <span style=font-size:110%;font-weight:bold;> &ensp;"
              + "Not Running" + "</span>";
            }
          break;

          default:
            console.log(msg); //If the message doesn't match any of our cases, log the message in the console.
          }};

    // Declare our graph for cycling data.
    var g = new Dygraph(document.getElementById("graphDiv"), data,
      {labels: ['Time','F','Temp'],
       series: {
          'F': {
            axis:'y1'}, // Put our fluoresence on the left axis.
          'Temp': {
            axis:'y2'}, // Put our temperature on the right axis.
          },
          axes: { // Declare two sets of axes.
                'y1': {},
                'y2': {},
          },
          title: 'Cycling Information',
          xlabel: 'Time',
          ylabel: 'Fluoresence (mV)',
          y2label: 'Temperature (Celsius)',
          drawPoints: true,
          showRoller: true,
          digitsAfterDecimal: 3,
          dateWindow: [date_win_min, date_win_max],
          showRangeSelector: true,
          axisLabelFontSize: 12,
    });

    // Declare the graph for PCR data.
    var pcr = new Dygraph(document.getElementById("divPCR"), data2,
      {labels: ['Cycle','FAM','Cy5'],
       series: {
         'FAM': {
          axis:'y1'},
         'HEX': {
          axis:'y1'},
          },
          axes: {
                'y1': {},
          },
          title: 'PCR Output',
          xlabel: 'Cycle',
          ylabel: 'Fluoresence (mV)',
          drawPoints: true,
          showRoller: true,
          digitsAfterDecimal: 3,
          dateWindow: [0,40], //This locks the x axis to 0-40.
          showRangeSelector: true,
          axisLabelFontSize: 14,
    });

//Functions Begin

      function onConnect(run, start, project, operator, experiment, config, comments, filename)
     {
       if(run == "true")
       {document.getElementById("startTime").innerHTML =  "<br> Start Time: <br> <br> <span style=font-size:110%> &ensp;" +
       start.bold() + "</span>";
       document.getElementById("projName").value = project;
       document.getElementById("opName").value = operator;
       document.getElementById('expName').value = experiment;
       document.getElementById('comments').value = comments;
       document.getElementById('filename').value = filename;
       a.innerHTML = config;

       document.getElementById('projName').disabled = true;
       document.getElementById('opName').disabled = true;
       document.getElementById('expName').disabled = true;
       document.getElementById("dropdown").style.pointerEvents = "none";
         document.getElementById("dropdown").style.opacity = "0.6";
       document.getElementById('filename').disabled = true;

       document.getElementById('startStopPCR').innerHTML = "Stop PCR";
       document.getElementById('startStopPCR').style.backgroundColor = 'Tomato';
       clientPressedStart = true;
        }
       }

       var timeFinishDisplay;
       function runFinished() {

         var timeFinished = new Date(); //initialize Start Time
         timeFinishDisplay = timeFinished.toLocaleTimeString();
         document.getElementById("finTime").innerHTML =  "<br> Finish Time: <br> <br> <span style=font-size:110%> &emsp;" +
         timeFinishDisplay.bold() + "</span>";


       }

      //Checks if project name, operator name, and configuration are filled out before run can begin
      function conditionsForStart()
      { if (String(document.getElementById("projName").value).trim().length == 0){
          alert("\nPlease fill out the Project Name.");
          return false;}

        else if ((String(document.getElementById("opName").value).trim().length == 0)) {
          alert("\nPlease fill out the Operator Name.");
          return false;}

        else if ((String(a.innerHTML).trim().length == 0)) {
          alert("\nPlease pick a Configuration.");
          return false;}

        else{return true;}
      }

      //These variables ensure that the same file name isn't used for two runs in a row
      var oldFileName;
      var newFileName = " ";
      var clientPressedStart = false; // Keeps Track of if the client pressed start.
      //opens a window prompt to confirm whether the user wants to start the program
      function startStopConfirmation() {
         if(conditionsForStart()) { //function only runs if true;
            if(String(document.getElementById('startStopPCR').innerHTML) == "Start PCR"){
              var displayFileName1;
              var timeStarted1 = new Date();
                //Sets the file name to display if there is no file name entered or if old and new file names match
                if (String(document.getElementById("filename").value).trim().length == 0 || oldFileName == newFileName) {
                  var nameOfProject = document.getElementById("projName").value;
                  var date = ("0" + (timeStarted1.getMonth()+1).toString()).slice(-2) + "-" + ("0" + timeStarted1.getDate().toString()).slice(-2)  + "-" + timeStarted1.getFullYear().toString().slice(-2);
                  var time = ("0" + timeStarted1.getHours()).slice(-2)  + "." +  ("0" + timeStarted1.getMinutes()).slice(-2);
                  var dateTime = date+ "_" + time;
                  displayFileName1 = nameOfProject + "_" + dateTime;
                  }
                else{displayFileName1 = document.getElementById("filename").value;
                  }
              let text = "Are you sure you want to start this PCR?\n\nAll previous data will be cleared and you will be starting this experiment with the following parameters:\n\n" +
              "Save Data Filename: " + displayFileName1  + "\nOperator Name: " + document.getElementById("opName").value + "\nExperiment Name: " + document.getElementById("expName").value +
              "\nConfiguration: " + a.innerHTML + "\n\nPress 'OK' to confirm.";
                if (confirm(text) == true) {
                  //Changes Button and System Status
                  document.getElementById('startStopPCR').innerHTML = "Stop PCR";
                    document.getElementById('startStopPCR').style.backgroundColor = 'Tomato';
                  clientPressedStart = true;
                  startStopPCR();}
                else {}
            }
            else{
              let text = "\nAttention: you are currently losing data. \n\nAre you sure you want to stop this PCR? \n\n If you do, the experiment will end.";
                //Changes Button and System Status
                if (confirm(text) == true) {
                  document.getElementById('startStopPCR').innerHTML = "Start PCR";
                    document.getElementById('startStopPCR').style.backgroundColor = 'LimeGreen';
                  clientPressedStart = false;
                  startStopPCR();
                  runFinished();}
                else{}
            }
          }
        }

    var timeStartDisplay; //Important if we ever want to send it
    var defaultFileName; //Important if we ever want to send it
    // Start or stop the PCR depending on its current state.
    function startStopPCR() {
      if (clientPressedStart){ //Changes the file name between runs if its the exact same
        if (oldFileName == newFileName){
          newFileName = " ";
          document.getElementById('filename').value = " ";
        }
        //Displays Start Time
        var timeStarted = new Date(); //initialize Start Time
        timeStartDisplay = timeStarted.toLocaleTimeString();
        document.getElementById("startTime").innerHTML =  "<br> Start Time: <br> <br> <span style=font-size:110%> &ensp;" +
        timeStartDisplay.bold() + "</span>";
        document.getElementById("finTime").innerHTML =  "<br> Finish Time: <br> <br> <span style=font-size:110%> &emsp;  &emsp; &emsp; -" + "</span>";
        //This code alters the default file name.
          if (String(document.getElementById("filename").value).trim().length == 0){
            var nameOfProject = document.getElementById("projName").value;
            //alert(nameOfProject)
            var date = ("0" + (timeStarted.getMonth()+1).toString()).slice(-2) + "-" + ("0" + timeStarted.getDate().toString()).slice(-2)  + "-" + timeStarted.getFullYear().toString().slice(-2);
            //alert(date);
            var time = ("0" + timeStarted.getHours()).slice(-2)  + "." +  ("0" + timeStarted.getMinutes()).slice(-2);
            var dateTime = date+ "_" + time;
            defaultFileName = nameOfProject + "_" + dateTime;
            document.getElementById('filename').value = defaultFileName;
          }
          newFileName = String(document.getElementById('filename').value);
          //This code disables all major entry fields
            document.getElementById('projName').disabled = true;
            document.getElementById('opName').disabled = true;
            document.getElementById('expName').disabled = true;
            document.getElementById("dropdown").style.pointerEvents = "none";
              document.getElementById("dropdown").style.opacity = "0.6";
            document.getElementById('filename').disabled = true;
          //alert("Machine Started/Stopped");
          //Code to reset graph related things
          data = [];
          data2 = [];
          cycleno = 0;
            document.getElementById("currentCycle").innerHTML =  "<span style='font-weight:bold; font-size:110%'>" + cycleno + "</span>";
          t = new Date();
            date_win_min = t.getTime();
            date_win_max = date_win_min + 2*taxis_increment;
            g.updateOptions( { dateWindow : [date_win_min, date_win_max] } );
          data.push([t, 0, 0]);
          data2.push([cycleno, 0, 0]);
          g.updateOptions({ 'file': data});
          pcr.updateOptions({ 'file': data2});

          changeFile();
          clientPressedStart = false;
          var msg = {
            id: "startSave",
            startTime: timeStartDisplay,
            projectName: document.getElementById("projName").value,
            operator: document.getElementById("opName").value,
            experimentName: document.getElementById('expName').value,
            config: a.innerHTML,
            comments: document.getElementById('comments').value,
            filename: document.getElementById('filename').value
          };
          ws.send(JSON.stringify(msg)); //sends message, finally

      }
      else{
        //This code enables all major entry fields
        document.getElementById('projName').disabled = false;
        document.getElementById('opName').disabled = false;
        document.getElementById('expName').disabled = false;
        document.getElementById("dropdown").style.pointerEvents = "auto";
          document.getElementById("dropdown").style.opacity = "1";
        document.getElementById('filename').disabled = false;
        oldFileName = newFileName; //for storing purposes
        clientPressedStart = true;
      }
      var msg = {
        id: "start/stop"
      };
      ws.send(JSON.stringify(msg)); //sends message, finally
    }

      //Changes files based off the textbox on the page and sends the name to the server. The server will reject the request if it's running.
      // Need to make something that tells the user that the server has rejected the request
      //This Function should run prior to the actual start. Never called on outside of a function.
      function changeFile()
        {var nameforchange = document.getElementById("filename").value;
          var msg = {
            id: "filename",
            newname: nameforchange};
          ws.send(JSON.stringify(msg));}

      // Need to implement this feature that will send the files to the chosen address --> Should be error prone.
      //Currently Emails the files to Nick
      //This function should only be called when Email Data is pressed.
      function sendFiles() {
        if((String(document.getElementById("email").value).trim().length == 0) || ((!String(document.getElementById("email").value).trim().includes("@")))){
          alert("Please enter a valid email address")
        }
        else{
          var msg = {
            id: "sendemail"};
          ws.send(JSON.stringify(msg));
        }
      }

      //Need to implement a function that calculates the Estimated Finish Time
      function estFinishTime(data)
      {return "Calculating..."}

      //Need to implement a feature that download data
      function downloadData(){}

      //opens a window prompt to confirm whether the user meant to close the website
      function closeConfirmation() {
        let text = "\nAre you sure you want to close this website?\n\n If currently running, the machine will continue to run.\n\nPress 'OK' to confirm.";
        if (confirm(text) == true) {
          window.close(); //Add more things to this function, in the future.
        } else {}
        }

      //opens a window prompt to confirm whether the user meant to shutdown the server.
      function shutdownConfirmation() {
        let text = "\nAre you sure you want to shutdown this Server?\n\nIf you do Nick will be mad.\n\nPress 'OK' to confirm.";
        if (confirm(text) == true) {
          stopServer();
        } else {}
        }

      //Turns the server off. This function should usually NEVER be called.
      function stopServer() {
        //alert("Server Stopped");
        document.getElementById('serverStatus').innerHTML =  "Server Status: <span style = 'font-weight:bold;''> Not Connected </span>";
        var msg = {
          id: "shutdown"};
        ws.send(JSON.stringify(msg));
      }

      //Opens a new page so the user can get Help (Implement it so its the manual) --> change in the future
      function help(){
        window.open("https://my.vanderbilt.edu/haseltonlab/");
      }

//Functions End

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

// Code for the tabs starts
      function show(evt, contentid) { //Shows content tabs when tabs are clicked
        var i, tabcontent, tablinks;
          tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
            }
          tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
              tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
        document.getElementById(contentid).style.display = "block";
        evt.currentTarget.className += " active"; }

        document.getElementById("tab1").click(); //By Default, the first tab is shown.
// Code for the tabs ends

// Code for the dropdown on the first page starts
      var x, i, j, l, ll, selElmnt, a, b, c;
      x = document.getElementsByClassName("custom-select"); /*looks for elements with the class "custom-select":*/
      l = x.length;
      for (i = 0; i < l; i++) {
        selElmnt = x[i].getElementsByTagName("select")[0];
        ll = selElmnt.length;

        /*creates a new DIV that acts as the selected item for each element*/
        a = document.createElement("DIV");
        a.setAttribute("class", "select-selected");
        a.innerHTML = selElmnt.options[selElmnt.selectedIndex].innerHTML;
        x[i].appendChild(a);

        /*Creates a new DIV that will contain the option list for each element*/
        b = document.createElement("DIV");
        b.setAttribute("class", "select-items select-hide");

        for (j = 0 ; j < ll; j++) {

          /*for each option in the original select element,
          creates a new DIV that will act as an option item:*/
          c = document.createElement("DIV");
          c.innerHTML = selElmnt.options[j].innerHTML;
          c.addEventListener("click", function(e) {

              /*when an item is clicked, updates the original select box,
              and the selected item:*/
              var y, i, k, s, h, sl, yl;
              s = this.parentNode.parentNode.getElementsByTagName("select")[0];
              sl = s.length;
              h = this.parentNode.previousSibling;
              for (i = 0; i < sl; i++) {
                if (s.options[i].innerHTML == this.innerHTML) {
                  s.selectedIndex = i;
                  h.innerHTML = this.innerHTML;
                  y = this.parentNode.getElementsByClassName("same-as-selected");
                  yl = y.length;
                  for (k = 0; k < yl; k++) {
                    y[k].removeAttribute("class");
                  }
                  this.setAttribute("class", "same-as-selected");
                  break;}
              }
              h.click();
            });
          b.appendChild(c);}
        x[i].appendChild(b);
        a.addEventListener("click", function(e) {

            /*when the select box is clicked, close any other select boxes,
            and open/close the current select box:*/
            e.stopPropagation();
            closeAllSelect(this);
            this.nextSibling.classList.toggle("select-hide");
            this.classList.toggle("select-arrow-active");
          });
      }

      /*Closes all select boxes in the document,except the current select box:*/
      function closeAllSelect(elmnt) {
        var x, y, i, xl, yl, arrNo = [];
        x = document.getElementsByClassName("select-items");
        y = document.getElementsByClassName("select-selected");
        xl = x.length;
        yl = y.length;
        for (i = 0; i < yl; i++) {
          if (elmnt == y[i]) {
            arrNo.push(i)
          } else {y[i].classList.remove("select-arrow-active");}
        }
        for (i = 0; i < xl; i++) {
          if (arrNo.indexOf(i)) {
            x[i].classList.add("select-hide");}
        }
      }

      /*if the user clicks anywhere outside the select box,
      then close all select boxes:*/
      document.addEventListener("click", closeAllSelect);
// Code for the dropdown on the first page ends

  // Safety Feature if someone accidently refreshes or leaves the page
  window.onbeforeunload = function() {
    return "Are you sure you want to leave this page?";};

  </script>
</body>
</html>
