<!DOCTYPE html>
<html>
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"> <!--scales to client device size-->
  <title> CASPAR </title>

  <script src="https://www.puck-js.com/puck.js"></script>
  <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.css" />

<style>
  /* Purely stylistic so it looks pretty */
  body{font-family: verdana, Arial;}
  .tab button {font-size:120%; background-color:#f0f0f0; margin-top:8px; margin-right:8px; padding:5px; cursor:pointer;
   border-width:2px; border-radius: 3px}
    .tab button:hover {background-color: #b4b4b4;}
    .tab button.active {background-color: #787878; color: #f0f0f0}
  .tabcontent {}
  .inrbtn{display: block; font-size: 125%; background-color:#b4b4b4; padding: 12px; cursor: pointer;
   border-width: 2px; border-radius: 3px; margin: 53px auto;}
    .inrbtn2{display: block; font-size: 125%; background-color:#b4b4b4; padding: 12px; cursor: pointer;
    border-width: 2px; border-radius: 3px; margin:auto; margin-top: 48px; margin-bottom: 48px;}
    .inrbtn3{display: block; font-size: 150%; background-color:#b4b4b4; padding: 12px; cursor: pointer;
    border-width: 2px; border-radius: 3px; margin:auto; margin-top: 48px; margin-bottom: 48px;}
    .btmbtn{display: inline; font-size: 150%; background-color:#b4b4b4; padding: 5px; cursor: pointer;
    border-width: 2px; border-radius: 3px;}
  .inrtxt{font-size: 110%; text-align: center; margin:35px}
    .inrtxt2{font-size: 110%; text-align: center; margin:30px}
    .inrtxt3{font-size: 110%; margin:15px}
    .inrtxt4{font-size: 115%; margin-top:40px; margin-bottom: 20px;}
    .inrtxt5{font-size: 105%; margin-top:40px; margin-bottom: 20px;}
  .inrinp{type = "text"; width: 85%; height:25px; font-size:12pt; border-width: 1px; padding:3px 8px;}
    .btminp{type = "text"; width: 30%; height:50%; font-size:12pt; border-width: 1px; padding:3px 8px; resize: none; display:inline;}

  /* grids/layputs for each tab */
  .container1 {display: grid;
  grid-template-columns: 0.75fr 0.75fr 1fr 1fr 1fr 1fr 1fr 1fr 0.75fr 0.75fr;
  grid-template-rows: 1fr 1fr 1fr 1fr 1fr 1fr 0.4fr;
  grid-column-gap: 8px;
  grid-row-gap: 8px;}
  .div1-1 { grid-area: 1 / 1 / 6 / 3; border-style:solid; border-width: 2px} /*left content */
  .div2-1 { grid-area: 1 / 3 / 6 / 9; border-style:solid; border-width: 2px} /*middle content */
  .div3-1 { grid-area: 1 / 9 / 6 / 11; border-style:solid; border-width: 2px} /*right content */
  .div4-1 { grid-area: 6 / 1 / 8 / 11; border-style:solid; border-width: 2px;} /*bottom content */

  .container2 {display: grid;
  grid-template-columns: 0.75fr 0.75fr 1fr 1fr 1fr 1fr 1fr 1fr 0.75fr 0.75fr;
  grid-template-rows: 1fr 1fr 1fr 1fr 1fr 1fr 0.4fr;
  grid-column-gap: 8px;
  grid-row-gap: 8px;} /*same grid as container1*/
  .div1-2 { grid-area: 1 / 1 / 6 / 3; border-style:solid; border-width: 2px}
  .div2-2 { grid-area: 1 / 3 / 6 / 9; border-style:solid; border-width: 2px}
  .div3-2 { grid-area: 1 / 9 / 6 / 11; border-style:solid; border-width: 2px}
  .div4-2 { grid-area: 6 / 1 / 8 / 11; border-style:solid; border-width: 2px}

  .container3 {display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(4, 1fr);
    grid-column-gap: 8px;
    grid-row-gap: 8px;}
  .div1-3 { grid-area: 1 / 1 / 5 / 3; border-style:solid; border-width: 2px} /*left content */
  .div2-3 { grid-area: 1 / 3 / 5 / 5; border-style:solid; border-width: 2px} /*right content */

  /*DropDown Menu on the First Tab*/
  .custom-select {position: relative;}
    .custom-select select {display: none;} /*hide original select element:*/
  .select-selected {background-color:#b4b4b4; border: 6px;}
    .select-selected:after {position: absolute; content: ""; top: 14px; right: 10px;width: 0px; height: 0px; border: 6px solid transparent;
     border-color: #3c3c3c transparent transparent transparent;} /*point the arrow upwards when the select box is open:*/
    .select-selected.select-arrow-active:after { border-color: transparent transparent #3c3c3c transparent; top: 7px;}
  .select-items div,.select-selected {padding: 6px 8px; border: 1px solid transparent;
   border-color: #000000 #000000 #000000 #000000; cursor: pointer; user-select: none;} /*style the options*/
    .select-items {position: absolute; background-color: #b4b4b4; border-radius: 3px; top: 100%; left: 0; right: 0; z-index: 99;}
  .select-hide {display: none;} /*hide items when the select box is closed:*/
  .select-items div:hover, .same-as-selected {background-color: rgba(0, 0, 0, 0.1);}
</style>
</head>

<body>

  <div class="tab">
    <button class="tablinks" id = "tab1" onclick="show(event, 'tab1c')">Main</button>
    <button class="tablinks" id = "tab2" onclick="show(event, 'tab2c')">Results</button>
    <button class="tablinks" id = "tab3" onclick="show(event, 'tab3c')">Configure</button>
    <button id="help" style="float:right"> Help </button>
    <button id="closeServer" style="float:right" onclick = "shutdownConfirmation()"> Shutdown Server (DO NOT PRESS) </button>
  </div>

  <div id="divider" style="width:1200px; height:8px; margin: auto;"></div>

  <div id="tab1c" class="tabcontent">
    <div class="container1">

      <div class="div1-1"  style = "text-align:center;">
        <p class="inrtxt2">Project Name:</p>
        <input class = "inrinp" id="projName">
        <p class="inrtxt2">Operator:</p>
        <input class = "inrinp" id="opName">
        <p class="inrtxt2">Experiment Name:</p>
        <input class = "inrinp" id="expName">
        <p class="inrtxt2">Recipes:</p>
        <div class="custom-select" style="width:93%; margin:0 auto;">
          <select style="text-align:left">
            <option value="0" id="none">&emsp;</option> <!-- blank line -->
            <option value="1" id="V">V</option> <!--Change-->
            <option value="2" id="W">W</option> <!--Change-->
            <option value="3" id="X">X</option> <!--Change-->
            <option value="4" id="Y">Y</option> <!--Change-->
            <option value="5" id="Z">Z</option> <!--Change-->
          </select>
        </div>
      </div>

      <div class="div2-1" id="graphDiv" style="width:100%; height:100%; display:block!important;"></div> <!--graph goes here-->

      <div class="div3-1">
        <button class="inrbtn" id="startPCR" style=""> Start PCR </button>
        <button class="inrbtn" id="stopPCR" onclick="startStopPCR()"> Stop PCR </button>
        <p class="inrtxt">Current Cycle:</p>
        <p class="inrtxt" id="currentCycle" style="font-weight:bold; font-size:120%">1</p> <!--can be changed-->
        <p class="inrtxt">Total Cycles:</p>
        <p class="inrtxt" id="totalCycles" style="font-weight:bold; font-size:120%">50</p> <!--can be changed-->
      </div>

      <div class="div4-1">
        <p class="inrtxt3" style="margin-top: 42px; display:inline; float:left; font-size:110%; ">Operator <br> <br> Comments:</p>
        <textarea class = "btminp" id="operatorComments" style="display:inline-flex; margin-top: 40px; float:left;"></textarea>
        <p class="inrtxt3" id="systemStatus" style="display:inline; float:left; font-size:110%; margin-left:45px;"> <br> Status: <br> <br>
          <span style= "font-weight: bold; font-size:110%; color: #48c531"> &emsp;In Progress </span></p> <!--can be changed-->
        <p class="inrtxt3" id="startTime" style="display:inline; float:left; font-size:110%; margin-left:45px;"> <br> Start Time:
          <br> <br> <span style= "font-weight: bold; font-size:110%"> &emsp;12:34:56 </span></p> <!--can be changed-->
        <p class="inrtxt3" id="estFinTime" style="display:inline; float:left; font-size:110%; margin-left:45px;"> <br> Est. Finish Time:
          <br> <br> <span style= "font-weight: bold; font-size:110%"> &emsp;03:14:15 </span></p> <!--can be changed-->
        <button class="btmbtn" id="quit" style = "float:right; margin-top: 42px; margin-right: 65px; padding:12px;" onclick =
          "quitConfirmation()"> Quit Program </button>
      </div>

    </div>
  </div>

  <div id="tab2c" class="tabcontent">
    <div class="container2">

      <div class="div1-2">
        <p class="inrtxt4" style="font-weight:bold; text-align: center;">Experiment Info:</p>
        <p class="inrtxt5" id="errorMessages">&emsp;Not Completed <br> &emsp;Check Error Status</p> <!-- Can be changed -->
        <p class="inrtxt4" style="font-weight:bold; text-align: center;">Device Info:</p>
        <p class="inrtxt5" id="deviceInfo">&emsp;Model 1.0</p> <!-- Can be changed -->
        <p class="inrtxt4" style="font-weight:bold; text-align: center;">Version Info:</p>
        <p class="inrtxt5" id="versionInfo">&emsp;Version 1.0</p> <!-- Can be changed -->
      </div>

      <div class="div2-2" id="divPCR" style="width:100%; height:100%; display:block!important;"> </div> <!--graph goes here-->

      <div class="div3-2" style = "text-align:center;">
        <p class="inrtxt4"  style = "margin-bottom: 30px;">Save Data Filename:</p>
        <input class = "inrinp" id="filename" value="projName_Date_Time"> <!-- Can be changed -->
        <p class="inrtxt4" style = "margin-bottom: 25px;">Enter Email:</p>
        <input class = "inrinp" id="email" style = "margin-bottom: 20px; font-size:11pt;">
        <button class="inrbtn2" id="emailData" style = "margin-top: 10px; margin-bottom: 60px; padding:8px; font-size:115%">
          Email Data </button>
        <button class="inrbtn2" id="downloadData" style = "margin-top: 73px; padding:16px; font-size:125%"> Download Data </button>
      </div>

      <div class="div4-2">
        <p class="inrtxt3" style="margin-top: 42px; display:inline; float:left; font-size:120%; ">Current Save <br>
        <br> Filepath:</p>
        <p class="inrtxt3" id="filepath" style="margin-top: 50px; display:inline; float:left; font-size:110%; border-style: solid;
          border-width:1px; padding: 15px;"> C:\Users\Bob\Desktop\adapPCRRuns\May\CASPAR</p> <!-- Can be changed -->
        <button class="btmbtn" id="changeFilepath" style = "float:left; margin-top: 35px; margin-left: 30px; padding:12px; font-size:140%">
          Change Save <br> Filepath</button>
        <button class="btmbtn" id="saveData" style = "float:left; margin-top: 50px; margin-left: 40px; padding:12px; font-size:140%">
          Save Data</button>
        <p class="inrtxt3" id="systemStatus" style="display:inline; float:left; font-size:110%; margin-left:45px;"> <br> Run Status:
          <br> <br> <span style= "font-weight: bold; font-size:110%;"> &emsp;Completed </span></p> <!--can be changed-->
        <button class="btmbtn" id="quit" style = "float:right; margin-top: 42px; margin-right: 65px; padding:12px;" onclick =
          "quitConfirmation()"> Quit Program </button>
      </div>

    </div>
  </div>

  <div id="tab3c" class="tabcontent">
    <div class="container3">

      <div class="div1-3">
        <h2 style = "text-align: center;"> Configuration Information </h2>
        <p class = 'inrtxt3' id = configurationInfo> Total Cycles: 3 <br> Recipe: W </p> <!--can be changed-->
        <button class="inrbtn3" id="devMode" > Launch <br> Developer <br> Mode </button>
      </div>

      <div class="div2-3">
        <h2 style = "text-align: center;"> Error Status </h2>
        <p class = 'inrtxt3' id="errorInfo"> No errors </p>
      </div>

    </div>
  </div>

  <script type="text/javascript">
    const ws = new WebSocket('ws://10.8.129.234:7071/ws');

    //Declare data vectors for graphs and push initial values into them.
    var data = [];
    var data2 =[];
    var cycleno = 0;             // Cycle the next set of PCR data will be from.
    var t = new Date();         // Current time.
    data.push([t, 0, 0]);
    data2.push([cycleno, 0, 0]);

    // Harness a variable to each button to handle events later.                 Add more here.
    var startStopPCR = document.getElementById("startPCR");
    var emailMyFiles = document.getElementById("emailData"); // Not Active
    var serverShutdown = document.getElementById("closeServer"); // Not Active

    var taxis_increment = 10 * 1000; // axis increment in milliseconds

    // Initialize variables for data handling.
    var x = 0;
    var y = 0;
    var fam;
    var cy5;
    var cycleno = 0;
    var date_win_min = t.getTime();
    var date_win_max = date_win_min + 2*taxis_increment;

    // Handles the events coming from the websocket. Format switches off the id blank on the json variable being sent.
    ws.onmessage = function(event){
      var msg = JSON.parse(event.data);
        switch(msg.id){
          case "connect":
            console.log(msg.status);
          break;
          case "cycledata":
            x = new Date();  // Get current time
            y = msg.fluor; // Get fluoresence.
            temp = msg.temp; // Get temperature.

            //Move the window if needed:
            if (x.getTime() >= date_win_max) {
              date_win_min += taxis_increment;
              date_win_max += taxis_increment;
              g.updateOptions( { dateWindow : [date_win_min, date_win_max] } )};

            //Update the data, then graph it.
            if(y > -100)
              {data.push([x,y,temp]);
               g.updateOptions( { 'file': data } );};
          break;
          case "PCRdata":
            cycleno = cycleno + 1; //Increase PCR cycle on receipt of PCR data.
            fam = msg.fam; //Retrieve FAM fluoresence.
            cy5 = msg.cyfive; //Retrieve Cy5 fluoresence.
            data2.push([cycleno, fam, cy5]); //Push the new data onto the graph source.
            pcr.updateOptions( {'file': data2 } ); //Update it.
          break;
          case "filestatus":
            console.log(msg.status); //Log the confirmation of filename change.
          break;
          default:
            console.log(msg); //If the message doesn't match any of our cases, log the message in the console.
          }};

    // Declare our graph for cycling data.
    var g = new Dygraph(document.getElementById("graphDiv"), data,
      {labels: ['Time','F','Temp'],
       series: {
          'F': {
            axis:'y1'}, // Put our fluoresence on the left axis.
          'Temp': {
            axis:'y2'}, // Put our temperature on the right axis.
          },
          axes: { // Declare two sets of axes.
                'y1': {},
                'y2': {},
          },
          title: 'Cycling Information',
          xlabel: 'Time',
          ylabel: 'Fluoresence (mV)',
          y2label: 'Temperature (Celsius)',
          drawPoints: true,
          showRoller: true,
          digitsAfterDecimal: 3,
          dateWindow: [date_win_min, date_win_max],
          showRangeSelector: true,
          axisLabelFontSize: 12,
    });

    // Declare the graph for PCR data.
    var pcr = new Dygraph(document.getElementById("divPCR"), data2,
      {labels: ['Cycle','FAM','Cy5'],
       series: {
         'FAM': {
          axis:'y1'},
         'HEX': {
          axis:'y1'},
          },
          axes: {
                'y1': {},
          },
          title: 'PCR Output',
          xlabel: 'Cycle',
          ylabel: 'Fluoresence (mV)',
          drawPoints: true,
          showRoller: true,
          digitsAfterDecimal: 3,
          dateWindow: [0,40], //This locks the x axis to 0-40.
          showRangeSelector: true,
          axisLabelFontSize: 14,
    });

    //Functions Begin

    //Changes files based off the textbox on the page and sends the name to the server. The server will reject the request if it's running.
    // This Function should run only inside other functions
    function changeFile()
      {var nameforchange = document.getElementById("filename").value;
        var msg = {
          id: "filename",
          newname: nameforchange};
        ws.send(JSON.stringify(msg));}

    //Turns the server off. Don't call this. Really don't.
    function stopServer() {
      var msg = {
        id: "shutdown"};
      ws.send(JSON.stringify(msg));}

    // Start or stop the PCR depending on its current state.
    function startStopPCR() {
      var msg = {
        id: "start/stop"};
      ws.send(JSON.stringify(msg));}

    // Rewriting this to email the files to a chosen address.
    // function sendFiles() { // Change to email the files to a chosen address
    //  var msg = {
    //    id: "sendemail"};
    //  ws.send(JSON.stringify(msg));}

    //opens a window prompt to confirm whether the user meant to quit the program.
    function quitConfirmation() {
      let text = "Are you sure you want to quit this program?\n\nPress 'OK' to confirm.";
      if (confirm(text) == true) {
        window.close(); //Add more things to this function
      } else {}
      }

    //opens a window prompt to confirm whether the user meant to shutdown the server.
    function shutdownConfirmation() {
      let text = "Are you sure you want to shutdown this Server?\nIf you do Nick will be mad.\n\nPress 'OK' to confirm.";
      //Edit before submit
      if (confirm(text) == true) {
        stopServer();
      } else {}
      }

    //Sets up all the events for the events listener.
    $(document).ready(function () {
        startStopPCR.addEventListener("click", function () { startStopPCR() } );
        //emailMyFiles.addEventListener("click", function () { sendFiles() } ); Commented out for now, will uncomment later
        //rec_startstop.addEventListener("click", function () { startstop_record() } ); Commented out because there is no use for it
        //serverShutdown.addEventListener("click", function () { stopServer()}); Commented out becuase now we have a window alert
        //submitfilename.addEventListener("click", function() {changeFile()}); Commented out becuase there is no use for it
        });

    //Shows content tabs when tabs are clicked
    function show(evt, contentid) {
      var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
          }
        tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
          }
      document.getElementById(contentid).style.display = "block";
      evt.currentTarget.className += " active"; }

    document.getElementById("tab1").click(); //By Default, the first tab is shown.

    // Code for the dropdown on the first page starts
    var x, i, j, l, ll, selElmnt, a, b, c;
    x = document.getElementsByClassName("custom-select"); /*looks for elements with the class "custom-select":*/
    l = x.length;
    for (i = 0; i < l; i++) {
      selElmnt = x[i].getElementsByTagName("select")[0];
      ll = selElmnt.length;

      /*creates a new DIV that acts as the selected item for each element*/
      a = document.createElement("DIV");
      a.setAttribute("class", "select-selected");
      a.innerHTML = selElmnt.options[selElmnt.selectedIndex].innerHTML;
      x[i].appendChild(a);

      /*Creates a new DIV that will contain the option list for each element*/
      b = document.createElement("DIV");
      b.setAttribute("class", "select-items select-hide");

      for (j = 0 ; j < ll; j++) {

        /*for each option in the original select element,
        creates a new DIV that will act as an option item:*/
        c = document.createElement("DIV");
        c.innerHTML = selElmnt.options[j].innerHTML;
        c.addEventListener("click", function(e) {

            /*when an item is clicked, updates the original select box,
            and the selected item:*/
            var y, i, k, s, h, sl, yl;
            s = this.parentNode.parentNode.getElementsByTagName("select")[0];
            sl = s.length;
            h = this.parentNode.previousSibling;
            for (i = 0; i < sl; i++) {
              if (s.options[i].innerHTML == this.innerHTML) {
                s.selectedIndex = i;
                h.innerHTML = this.innerHTML;
                y = this.parentNode.getElementsByClassName("same-as-selected");
                yl = y.length;
                for (k = 0; k < yl; k++) {
                  y[k].removeAttribute("class");
                }
                this.setAttribute("class", "same-as-selected");
                break;}
            }
            h.click();
          });
        b.appendChild(c);}
      x[i].appendChild(b);
      a.addEventListener("click", function(e) {

          /*when the select box is clicked, close any other select boxes,
          and open/close the current select box:*/
          e.stopPropagation();
          closeAllSelect(this);
          this.nextSibling.classList.toggle("select-hide");
          this.classList.toggle("select-arrow-active");
        });
    }

    /*Closes all select boxes in the document,except the current select box:*/
    function closeAllSelect(elmnt) {
      var x, y, i, xl, yl, arrNo = [];
      x = document.getElementsByClassName("select-items");
      y = document.getElementsByClassName("select-selected");
      xl = x.length;
      yl = y.length;
      for (i = 0; i < yl; i++) {
        if (elmnt == y[i]) {
          arrNo.push(i)
        } else {y[i].classList.remove("select-arrow-active");}
      }
      for (i = 0; i < xl; i++) {
        if (arrNo.indexOf(i)) {
          x[i].classList.add("select-hide");}
      }
    }

    /*if the user clicks anywhere outside the select box,
    then close all select boxes:*/
    document.addEventListener("click", closeAllSelect);
    // Code for the dropdown on the first page ends

  </script>
</body>
</html>
